# 交换以太网中的嗅探

与共享以太网不同的是，交换以太网采用的组网设备是交换机（Switch）而非共享总线或集线器（Hub）。交换机是一种基于MAC地址识别，能完成封装转发数据包功能的网络设备。交换机可以“学习”MAC地址，并把其存放在内部地址表中，通过在数据帧的始发者和 目标接收者之间建立临时的交换路径，使数据帧直接由源地址到达目的地址。



 



 







 



 



1.交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中。  

　　2.交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发。  

　　3.如数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发。这一过程称为泛洪（flood）。  

　　4.广播帧和组播帧向所有的端口转发。



 



1.1.1.1.1  MAC 地址溢出（MAC Flooding）



Switch 之所以能够由数据包中目的MAC地址判断出他应该把数据包发送到哪一个端口上是根据自身维护的一张ARP地址表，这张地址表可能是动态的也可能是静态的，如果是动态的地址表，并且其大小是有上限的，攻击者可以通过发送大量错误的地址信息而使Switch维护的地址表‘溢出’，从而使其变成广播模式。



1.1.1.1.2  ARP 欺骗（ARP Spoof）







假设A的IP地址是192.168.1.11



MAC地址是:11-11-11-11-11-11；



B的IP地址是 192.168.1.77



MAC地址是77-77-77-77-77-77



网关IP地址是192.168.1.1



MAC地址 是:01-01-01-01-01-01。



 



1\).A发送ARP欺骗包（ARP应答包）给B，告诉B：我（A）是网关，你把访问外网的数据发给我（A）吧！ARP欺骗包如下：



　　SrcIP: 192.168.1.1 ，SrcMAC:11-11-11-11-11-11



DstIP: 192.168.1.77 ，DstMAC:77-77-77-77-77-77



 



2\).A发送ARP欺骗包（ARP应答包）给网关，告诉网关：我（A）是机器B，结果网关把所有给B的数据都发到A那里了。ARP欺骗包如下：



　　SrcIP: 192.168.1. 77，SrcMAC:11-11-11-11-11-11



DstIP: 192.168.1. 1，DstMAC:01-01-01-01-01-01



 



3\).机器A有一个辅助用的转发软件，它负责把“网关-&gt;B”和“B-&gt;网关”的数据包转发。



 



 



至此，ARP欺骗的辅助任务完成了，接下来就是用你的嗅探器进行偷窥了～噢～哈哈！



这里有几点值得注意一下的：



 



1\).ARP欺骗包每隔一段时间要发一次，否则网关和B的ARP缓存会更新！



2\).ARP欺骗完成后，网关的ARP记录会有两记录的MAC地址是相同的，分别 是:192.168.1.11（11-11-11-11-11-11）和192.168.1.77（11-11-11-11-11-11），这样可能会比较明显，可以把A自己在网关的ARP缓存改了：192.168.1.11（01-10-01-10-01-10，乱写一个），但这样会有两个问题：一个是这个MAC是乱写的，局域网内根本没有这个MAC地址的机器，根据交换机的工作原理，网关发给192.168.1.11这IP的机器的数据将会被广播。第二个是，此刻你（A）的正常与外界通信的能力将会丧失。可以权衡考虑一下。



 



ARP欺骗就是通过发ARP应答包让网关和受害机的动态ARP表产生错误 IP-MAC 映射



1.1.1.1.1  交换机缓存欺骗



交换机里面有一张CAM表，记录了Mac－Port信息（这个端口对应的机器的MAC地址是什么），MAC信息的获取是：交换机从转发的数据包中提取。所谓欺骗交换机缓存，就是修改这张CAM表以达到欺骗交换机的目的！



 



假设有一个4端口的交换机，它的CAM表如下：



　  port1 -- 11-11-11-11-11-11



　　port2 -- 22-22-22-22-22-22



　　port3 -- 33-33-33-33-33-33



port4 -- 44-44-44-44-44-44



 



现在port1的机器A（IP是192.168.1.11，MAC地址为11-11-11-11-11-11）想要嗅探port2的机器B（IP是192.168.1.22，MAC地址为22-22-22-22-22-22），怎么办呢？流程如下：



 



 



1）机器A对外发送一个数据包，如下：



 



SrcIP:192.168.1.11  ScrMac:22-22-22-22-22-22



DstIP:xxx.xxx.xxx.xxx（随便写），DstMac:xx-xx-xx-xx-xx-xx（随便写）



 



　　此时，交换机收到这个包，发现在原来CAM里面，port1对应的机器MAC地址是11-11-11-11-11-11，怎么现在变为：22-22-22-22-22-22了呢？？哦，应该是这台机器的MAC地址变了吧～好！那我更新CAM表！



 



更新后的交换机CAM表如下：



 



　　port1 -- 22-22-22-22-22-22 （注意：Port1比Port2优先级高）



　　port2 -- 22-22-22-22-22-22



　　port3 -- 33-33-33-33-33-33



port4 -- 44-44-44-44-44-44



 



2）现在有port1和port2对应的MAC地址是一样的。如果现在网关（假设现在port4连接的是网关）来了一个数据包是给机器B（IP是 192.168.1.22，MAC地址为22-22-22-22-22-22），交换机会顺序查询此刻的CAM表来确定该数据包转发去哪个端口！在查询 port1时，发现此端口对应MAC地址和数据包里的MAC地址相同，交换机直接就把包转发到port1的机器A了，由于该包已转发完毕，交换机继续处理 下一个数据包......就这样，数据包又再次落入充满窥探欲望的人手中！



 



这里也需要注意几个问题：



　　1\).A收到包后，还是需要转发给B的，不然B和外面的对话就中断了。



2\).当A把包转发给B时，需要修复交换机的CAM表。



 



交换机缓存欺骗就是通过发特定的包给交换机，让其CAM表产生错误的 PORT-MAC 映射



1.1.1.2  核心交换节点的嗅探



在核心交换结点，数据是从该结点上直接流过的，因此在功能上实现嗅探十分容易。但是仅仅是“看”到数据没有任何意义，从中提取出信息才是嗅探的最终目的。而想要对这里巨大的网络流量 进行分析却不是一件容易的事，以目前的计算能力，只能采用分布式处理的技术，将分析工作分给多个处理器去完成。 



 



恶意的嗅探很难在核心交换结点处实现——除非这里已经完全被攻击者接管。否则，即使攻击者成功的运行了侦听程序（已经可以用幸运来形容了），在安防措施极为严密的地方，想要搭建分布式的分析环境是不可想象的，同样，想要将庞大数据传送到远端作分析而不被发觉难度也是非常大的

